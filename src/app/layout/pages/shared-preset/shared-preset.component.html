<p-toast></p-toast>
<p-confirmDialog [position]="'top'" [style]="{ width: '25vw' }"></p-confirmDialog>

<div class="grid grid-nogutter">
  <!-- Class filter (listbox) -->
  <div class="col-12 mb-2">
    <div class="grid grid-nogutter column_list">
      <p-listbox [options]="allClasses" [(ngModel)]="selectedClassId" (onChange)="onSelectClassChange()" [disabled]="isLoading">
        <ng-template let-item pTemplate="item" class="py-0">
          <div class="flex gap-2 py-0">
            <img src="assets/demo/images/jobs/icon_jobs_{{ item.icon }}.png" alt="" class="job_img" />
            <div class="text_ellips">{{ item.label }}</div>
          </div>
        </ng-template>
      </p-listbox>
    </div>
  </div>

  <!-- My Builds toggle (logged-in only) -->
  <div class="col-12 mb-2 flex align-items-center gap-3" *ngIf="isLoggedIn">
    <p-inputSwitch [(ngModel)]="showMyBuilds" (onChange)="onShowMyBuildsChange()"></p-inputSwitch>
    <label>Minhas Builds</label>
  </div>

  <!-- Builds list -->
  <div class="col-12">
    <p-table
      styleClass="p-datatable-striped"
      [value]="builds"
      [loading]="isLoading"
      [tableStyle]="{ 'min-width': '50rem' }"
      [showCurrentPageReport]="true"
      [paginator]="true"
      (onPage)="pageChange($event)"
      [first]="firstRecord"
      [rows]="pageLimit"
      [totalRecords]="totalRecord"
      [lazy]="true"
      [rowsPerPageOptions]="pageOptions"
    >
      <ng-template pTemplate="body" let-build>
        <tr>
          <td>
            <div class="grid grid-nogutter">
              <!-- Header: name + actions -->
              <div class="col-12 flex justify-content-between align-items-center mb-2">
                <div class="flex align-items-center gap-2">
                  <!-- Like button (logged in) -->
                  <div class="like_section" *ngIf="isLoggedIn">
                    <button
                      *ngIf="!build.liked"
                      pButton
                      icon="pi pi-thumbs-up text-2xl"
                      class="p-button-text p-button-rounded"
                      (click)="likeBuild(build.id)"
                    ></button>
                    <button
                      *ngIf="build.liked"
                      pButton
                      icon="pi pi-thumbs-up-fill text-2xl"
                      class="p-button-text p-button-rounded"
                      (click)="unlikeBuild(build.id)"
                    ></button>
                    <span class="px-1 font-bold text-primary">{{ build.likeCount || 0 }}</span>
                  </div>
                  <!-- Like count for anonymous -->
                  <div *ngIf="!isLoggedIn" class="flex align-items-center gap-1">
                    <i class="pi pi-thumbs-up"></i>
                    <span class="font-bold text-primary">{{ build.likeCount || 0 }}</span>
                  </div>
                  <div class="font-bold text-2xl">{{ build.name }}</div>
                </div>
                <div class="flex align-items-center gap-1">
                  <!-- Copy link -->
                  <button
                    pButton
                    icon="pi pi-link"
                    class="p-button-text p-button-rounded"
                    pTooltip="Copiar link"
                    (click)="copyLink(build.id)"
                  ></button>
                  <!-- Import (logged in) -->
                  <button
                    *ngIf="isLoggedIn"
                    pButton
                    icon="pi pi-download"
                    label="Importar"
                    class="p-button-info p-button-sm"
                    (click)="importBuild(build)"
                  ></button>
                  <!-- Delete (author only) -->
                  <button
                    *ngIf="build.userId === currentUserId"
                    pButton
                    icon="pi pi-trash"
                    class="p-button-text p-button-rounded p-button-danger"
                    pTooltip="Excluir"
                    (click)="deleteBuild(build)"
                  ></button>
                </div>
              </div>

              <!-- Equipment display -->
              <div class="col-8" style="min-width: 400px; overflow: hidden">
                <app-equipment-ui [itemMap]="itemMap" [model]="build.model"></app-equipment-ui>
              </div>

              <!-- Stats + Metrics from snapshot -->
              <div class="col-4">
                <div class="grid grid-nogutter">
                  <div class="col-6">
                    Level: <span class="summary_highlight text-xl font-semibold">{{ build.model?.level }}</span>
                  </div>
                  <div class="col-6">
                    Job: <span class="summary_highlight text-xl font-semibold">{{ build.model?.jobLevel }}</span>
                  </div>
                  <div class="col-6">Str: <span class="summary_stat_atk text-xl">{{ build.model?.str }}</span></div>
                  <div class="col-6">Int: <span class="summary_stat_matk text-xl">{{ build.model?.int }}</span></div>
                  <div class="col-6">
                    Dex: <span class="summary_stat_atk text-xl" style="color: var(--green-300)">{{ build.model?.dex }}</span>
                  </div>
                  <div class="col-6">Agi: <span class="summary_stat_def text-xl">{{ build.model?.agi }}</span></div>
                  <div class="col-6">Vit: <span class="summary_stat_def text-xl">{{ build.model?.vit }}</span></div>
                  <div class="col-6">Luk: <span class="summary_stat_def text-xl">{{ build.model?.luk }}</span></div>
                </div>
                <!-- Metrics snapshot -->
                <div class="grid grid-nogutter mt-2" *ngIf="build.metrics">
                  <div class="col-12 font-semibold mb-1">
                    <i class="pi pi-bolt"></i> {{ build.skillName || '-' }} vs {{ build.monsterName || '-' }}
                  </div>
                  <div class="col-6">DPS: <span class="font-semibold text-primary">{{ build.metrics.dps | number }}</span></div>
                  <div class="col-6">Dano: <span class="font-semibold summary_stat_atk">{{ build.metrics.maxDamage | number }}</span></div>
                  <div class="col-6">ASPD: <span class="font-semibold summary_stat_atk">{{ build.metrics.aspd }}</span></div>
                  <div class="col-6">Hit/s: <span class="font-semibold summary_highlight">{{ build.metrics.hitPerSecs }}</span></div>
                  <div class="col-6">CriRate: <span class="font-semibold summary_stat_atk">{{ build.metrics.criRate }}%</span></div>
                  <div class="col-6">CriDmg: <span class="font-semibold summary_stat_atk">{{ build.metrics.criDmg }}%</span></div>
                  <div class="col-6">VCT: <span class="font-semibold summary_stat_matk">{{ build.metrics.vct }}</span></div>
                  <div class="col-6">FCT: <span class="font-semibold summary_stat_matk">{{ build.metrics.fct }}</span></div>
                </div>
                <div class="mt-1 text-sm" style="color: var(--text-color-secondary)">
                  {{ build.createdAt | date:'dd/MM/yyyy HH:mm' }}
                </div>
              </div>

              <!-- Detail toggle -->
              <div class="col-12 mt-2" *ngIf="viewDetail[build.id]">
                <div class="grid grid-nogutter">
                  <div class="col-5">
                    <app-equipment-in-detail [itemMap]="itemMap" [model]="build.model"></app-equipment-in-detail>
                  </div>
                </div>
              </div>
              <div class="col-12 flex justify-content-end">
                <p-inputSwitch inputId="{{ build.id }}" [(ngModel)]="viewDetail[build.id]"></p-inputSwitch>
                <label class="mx-2" for="{{ build.id }}">Ver detalhes</label>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td>NÃ£o encontrado</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
